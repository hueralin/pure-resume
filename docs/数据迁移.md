# 数据库备份恢复指南

本文档介绍如何在本地环境中恢复线上数据库备份文件。

## 前置条件

1. **PostgreSQL 工具链**：确保本地已安装 PostgreSQL，并且 `pg_restore` 命令在系统 PATH 环境变量中。
2. **备份文件**：获取根目录下的 `.sql` 或 `.sql.gz` 备份文件（例如 `resume_db_20251208231757e8rsy.sql`）。

## 恢复步骤

### 1. 解压备份文件

如果你的备份文件是压缩格式（`.gz`），请先解压：

```bash
# Windows (Git Bash) / macOS / Linux
gzip -d resume_db_xxxx.sql.gz
```

### 2. 执行恢复

由于备份文件是 PostgreSQL 的 **Custom Format (二进制格式)**，不能直接使用 SQL 编辑器打开或用 `psql` 运行，必须使用 `pg_restore` 工具。

#### 方案 A：完整恢复（推荐）
此命令会先清理本地同名数据库中的旧对象，确保与备份完全一致。

```bash
# 语法：pg_restore -h [主机] -U [用户名] -d [数据库名] --clean --if-exists [备份文件路径]

pg_restore -h localhost -U postgres -d resume_db --clean --if-exists resume_db_20251208231757e8rsy.sql
```
* `--clean`: 在恢复前删除现有的数据库对象（表、索引等）。
* `--if-exists`: 配合 `--clean` 使用，如果对象不存在不报错。

#### 方案 B：仅恢复数据
如果你确定本地表结构与线上完全一致，且只想导入数据（保留本地表结构）：

```bash
pg_restore -h localhost -U postgres -d resume_db --data-only --disable-triggers resume_db_20251208231757e8rsy.sql
```
* `--data-only`: 仅插入数据，不创建表。
* `--disable-triggers`: 临时禁用触发器（有助于避免外键约束问题）。
* **注意**：如果本地表中已有数据，可能会报主键冲突错误。建议先手动清空表 (`TRUNCATE`)。

## 常见问题

1.  **提示输入密码**
    *   执行命令后会提示输入密码。
    *   如果不想手动输入，可以在命令前加 `PGPASSWORD=你的密码`（注意安全）。
    
    ```bash
    PGPASSWORD=mypassword pg_restore ...
    ```

2.  **Command not found**
    *   如果提示找不到 `pg_restore` 命令，请将 PostgreSQL 的 `bin` 目录（例如 `C:\Program Files\PostgreSQL\16\bin`）添加到系统的 PATH 环境变量中。

